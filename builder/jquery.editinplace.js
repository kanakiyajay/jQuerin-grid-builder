(function(a){function c(a,b){this.settings=a;this.dom=b;this.originalValue=null;this.didInsertDefaultText=false;this.shouldDelayReinit=false}function d(a){if(a.url||a.callback)return;throw new Error("Need to set either url: or callback: option for the inline editor to work.")}function e(a){if(""===a)return;var b=new Image;b.src=a}function f(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")}function g(a){if(undefined===a||null===a)return false;if(0===a.length)return false;return true}a.fn.editInPlace=function(b){var f=a.extend({},a.fn.editInPlace.defaults,b);d(f);e(f.saving_image);return this.each(function(){var b=a(this);if(b.data("editInPlace"))return;b.data("editInPlace",true);(new c(f,b)).init()})};a.fn.editInPlace.defaults={url:"",bg_over:"black",bg_out:"transparent",hover_class:"",show_buttons:false,save_button:'<button class="inplace_save">Save</button>',cancel_button:'<button class="inplace_cancel">Cancel</button>',params:"",field_type:"text",default_text:"(Click here to add text)",use_html:false,textarea_rows:10,textarea_cols:25,select_text:"Choose new value",select_options:"",text_size:null,saving_text:undefined,saving_image:"",saving_animation_color:"transparent",value_required:false,element_id:"element_id",update_value:"update_value",original_value:"original_value",original_html:"original_html",save_if_nothing_changed:false,on_blur:"save",cancel:"",callback:null,callback_skip_dom_reset:false,success:null,error:null,error_sink:function(a,b){},preinit:null,postclose:null,delegate:null};var b={shouldOpenEditInPlace:function(a,b,c){},willOpenEditInPlace:function(a,b){},didOpenEditInPlace:function(a,b){},shouldCloseEditInPlace:function(a,b,c){},willCloseEditInPlace:function(a,b){},didCloseEditInPlace:function(a,b){},missingCommaErrorPreventer:""};a.extend(c.prototype,{init:function(){this.setDefaultTextIfNeccessary();this.connectOpeningEvents()},reinit:function(){if(this.shouldDelayReinit)return;this.triggerCallback(this.settings.postclose,this.dom);this.triggerDelegateCall("didCloseEditInPlace");this.markEditorAsInactive();this.connectOpeningEvents()},setDefaultTextIfNeccessary:function(){if(""!==this.dom.html())return;this.dom.html(this.settings.default_text);this.didInsertDefaultText=true},connectOpeningEvents:function(){var a=this;this.dom.bind("mouseenter.editInPlace",function(){a.addHoverEffect()}).bind("mouseleave.editInPlace",function(){a.removeHoverEffect()}).bind("click.editInPlace",function(b){a.openEditor(b)})},disconnectOpeningEvents:function(){this.dom.unbind(".editInPlace")},addHoverEffect:function(){if(this.settings.hover_class)this.dom.addClass(this.settings.hover_class);else this.dom.css("background-color",this.settings.bg_over)},removeHoverEffect:function(){if(this.settings.hover_class)this.dom.removeClass(this.settings.hover_class);else this.dom.css("background-color",this.settings.bg_out)},openEditor:function(a){if(!this.shouldOpenEditor(a))return;this.disconnectOpeningEvents();this.removeHoverEffect();this.removeInsertedDefaultTextIfNeccessary();this.saveOriginalValue();this.markEditorAsActive();this.replaceContentWithEditor();this.setInitialValue();this.workAroundMissingBlurBug();this.connectClosingEventsToEditor();this.triggerDelegateCall("didOpenEditInPlace")},shouldOpenEditor:function(a){if(this.isClickedObjectCancelled(a.target))return false;if(false===this.triggerCallback(this.settings.preinit,this.dom))return false;if(false===this.triggerDelegateCall("shouldOpenEditInPlace",true,a))return false;return true},removeInsertedDefaultTextIfNeccessary:function(){if(!this.didInsertDefaultText||this.dom.html()!==this.settings.default_text)return;this.dom.html("");this.didInsertDefaultText=false},isClickedObjectCancelled:function(b){if(!this.settings.cancel)return false;var c=a(b).parents().andSelf();var d=c.filter(this.settings.cancel);return 0!==d.length},saveOriginalValue:function(){if(this.settings.use_html)this.originalValue=this.dom.html();else this.originalValue=f(this.dom.text())},restoreOriginalValue:function(){this.setClosedEditorContent(this.originalValue)},setClosedEditorContent:function(a){if(this.settings.use_html)this.dom.html(a);else this.dom.text(a)},workAroundMissingBlurBug:function(){var a=this.dom.find(":input");this.dom.parents(":last").find(".editInPlace-active :input").not(a).blur()},replaceContentWithEditor:function(){var a=this.settings.show_buttons?this.settings.save_button+" "+this.settings.cancel_button:"";var b=this.createEditorElement();this.dom.html('<form class="inplace_form" style="display: inline; margin: 0; padding: 0;"></form>').find("form").append(b).append(a)},createEditorElement:function(){if(-1===a.inArray(this.settings.field_type,["text","textarea","select"]))throw"Unknown field_type <fnord>, supported are 'text', 'textarea' and 'select'";var b=null;if("select"===this.settings.field_type)b=this.createSelectEditor();else if("text"===this.settings.field_type)b=a('<input type="text" '+this.inputNameAndClass()+' size="'+this.settings.text_size+'" />');else if("textarea"===this.settings.field_type)b=a("<textarea "+this.inputNameAndClass()+' rows="'+this.settings.textarea_rows+'" '+' cols="'+this.settings.textarea_cols+'" />');return b},setInitialValue:function(){var a=this.triggerDelegateCall("willOpenEditInPlace",this.originalValue);var b=this.dom.find(":input");b.val(a);if(b.val()!==a)b.val("")},inputNameAndClass:function(){return' name="inplace_value" class="inplace_field" '},createSelectEditor:function(){var b=a("<select"+this.inputNameAndClass()+">"+'<option disabled="true" value="">'+this.settings.select_text+"</option>"+"</select>");var c=this.settings.select_options;if(!a.isArray(c))c=c.split(",");for(var d=0;d<c.length;d++){var e=c[d];if(!a.isArray(e))e=e.split(":");var g=f(e[1]||e[0]);var h=f(e[0]);var i=a("<option>").val(g).text(h);b.append(i)}return b},connectClosingEventsToEditor:function(){function c(a){b.handleCancelEditor(a);return false}function d(a){b.handleSaveEditor(a);return false}var b=this;var e=this.dom.find("form");e.find(".inplace_field").focus().select();e.find(".inplace_cancel").click(c);e.find(".inplace_save").click(d);if(!this.settings.show_buttons){if("save"===this.settings.on_blur)e.find(".inplace_field").blur(d);else e.find(".inplace_field").blur(c);if(a.browser.mozilla||a.browser.msie)this.bindSubmitOnEnterInInput()}e.keyup(function(a){var b=27;if(b===a.which)return c()});if(a.browser.safari)this.bindSubmitOnEnterInInput();e.submit(d)},bindSubmitOnEnterInInput:function(){if("textarea"===this.settings.field_type)return;var a=this;this.dom.find(":input").keyup(function(b){var c=13;if(c===b.which)return a.dom.find("form").submit()})},handleCancelEditor:function(a){if(false===this.triggerDelegateCall("shouldCloseEditInPlace",true,a))return;var b=this.dom.find(":input").val();b=this.triggerDelegateCall("willCloseEditInPlace",b);this.restoreOriginalValue();if(g(b)&&!this.isDisabledDefaultSelectChoice())this.setClosedEditorContent(b);this.reinit()},handleSaveEditor:function(a){if(false===this.triggerDelegateCall("shouldCloseEditInPlace",true,a))return;var b=this.dom.find(":input").val();b=this.triggerDelegateCall("willCloseEditInPlace",b);if(this.isDisabledDefaultSelectChoice()||this.isUnchangedInput(b)){this.handleCancelEditor(a);return}if(this.didForgetRequiredText(b)){this.handleCancelEditor(a);this.reportError("Error: You must enter a value to save this field");return}this.showSaving(b);if(this.settings.callback)this.handleSubmitToCallback(b);else this.handleSubmitToServer(b)},didForgetRequiredText:function(a){return this.settings.value_required&&(""===a||undefined===a||null===a)},isDisabledDefaultSelectChoice:function(){return this.dom.find("option").eq(0).is(":selected:disabled")},isUnchangedInput:function(a){return!this.settings.save_if_nothing_changed&&this.originalValue===a},showSaving:function(b){if(this.settings.callback&&this.settings.callback_skip_dom_reset)return;var c=b;if(g(this.settings.saving_text))c=this.settings.saving_text;if(g(this.settings.saving_image))c=a("<img />").attr("src",this.settings.saving_image).attr("alt",c);this.dom.html(c)},handleSubmitToCallback:function(a){this.enableOrDisableAnimationCallbacks(true,false);var b=this.triggerCallback(this.settings.callback,this.id(),a,this.originalValue,this.settings.params,this.savingAnimationCallbacks());if(this.settings.callback_skip_dom_reset);else if(undefined===b){this.reportError("Error: Failed to save value: "+a);this.restoreOriginalValue()}else this.dom.html(b);if(this.didCallNoCallbacks()){this.enableOrDisableAnimationCallbacks(false,false);this.reinit()}},handleSubmitToServer:function(b){var c=this.settings.update_value+"="+encodeURIComponent(b)+"&"+this.settings.element_id+"="+this.dom.attr("id")+(this.settings.params?"&"+this.settings.params:"")+"&"+this.settings.original_html+"="+encodeURIComponent(this.originalValue)+"&"+this.settings.original_value+"="+encodeURIComponent(this.originalValue);this.enableOrDisableAnimationCallbacks(true,false);this.didStartSaving();var d=this;a.ajax({url:d.settings.url,type:"POST",data:c,dataType:"html",complete:function(a){d.didEndSaving()},success:function(a){var b=a||d.settings.default_text;d.dom.html(b);d.triggerCallback(d.settings.success,a)},error:function(a){d.dom.html(d.originalHTML);if(d.settings.error)d.triggerCallback(d.settings.error,a);else d.reportError("Failed to save value: "+a.responseText||"Unspecified Error")}})},triggerCallback:function(a){if(!a)return;var b=Array.prototype.slice.call(arguments,1);return a.apply(this.dom[0],b)},triggerDelegateCall:function(b,c,d){if(!this.settings.delegate||!a.isFunction(this.settings.delegate[b]))return c;var e=this.settings.delegate[b](this.dom,this.settings,d);return undefined===e?c:e},reportError:function(a){this.triggerCallback(this.settings.error_sink,this.id(),a)},id:function(){return this.dom.attr("id")},markEditorAsActive:function(){this.dom.addClass("editInPlace-active")},markEditorAsInactive:function(){this.dom.removeClass("editInPlace-active")},savingAnimationCallbacks:function(){var a=this;return{didStartSaving:function(){a.didStartSaving()},didEndSaving:function(){a.didEndSaving()}}},enableOrDisableAnimationCallbacks:function(a,b){this.didStartSaving.enabled=a;this.didEndSaving.enabled=b},didCallNoCallbacks:function(){return this.didStartSaving.enabled&&!this.didEndSaving.enabled},assertCanCall:function(a){if(!this[a].enabled)throw new Error("Cannot call "+a+" now. See documentation for details.")},didStartSaving:function(){this.assertCanCall("didStartSaving");this.shouldDelayReinit=true;this.enableOrDisableAnimationCallbacks(false,true);this.startSavingAnimation()},didEndSaving:function(){this.assertCanCall("didEndSaving");this.shouldDelayReinit=false;this.enableOrDisableAnimationCallbacks(false,false);this.reinit();this.stopSavingAnimation()},startSavingAnimation:function(){var a=this;this.dom.animate({backgroundColor:this.settings.saving_animation_color},400).animate({backgroundColor:"transparent"},400,"swing",function(){setTimeout(function(){a.startSavingAnimation()},10)})},stopSavingAnimation:function(){this.dom.stop(true).css({backgroundColor:""})},missingCommaErrorPreventer:""})})(jQuery)